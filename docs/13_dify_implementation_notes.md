# Dify実装ノート（習熟メモ兼タスク管理）

作成日: 2026-02-12  
目的: Dify実装を進めながら「わからなかった点」を記録し、理解に変える

---

## 1. ゴール（このドキュメントの使い方）

- Dify連携を `UseCase -> Port -> Adapter -> Client` で成立させる
- 実装時に詰まった点を残し、あとで復習できるようにする
- 「動いた」だけで終わらず、「説明できる」状態にする

---

## 2. 前提（今回の設計方針）

- Port は Dify固有の JSON 形式を持たない
- Port の入出力は Domain 型で固定する
  - 入力: `Prompt`
  - 出力: `Response`
- Dify固有の request/response 変換は Adapter/Client 側で吸収する

現在の候補:
- `src/domain/ports/text_generator_port.py`

---

## 3. 実装スコープ（T4/T5/T6）

### T4: Port設計
- [ ] 既存 `TextGeneratorPort` をそのまま使うか最終判断
- [ ] 必要なら Port インターフェースを微修正（命名・引数・戻り値）
- [ ] UseCase が Port 経由で呼べることを確認

### T5: Dify Adapter + Client
- [ ] `src/infrastructure/dify/` を作成
- [ ] `dify_client.py` を作成（HTTP通信）
- [ ] `dify_adapter.py` を作成（Domain <-> Dify JSON 変換）
- [ ] APIキー/エンドポイント設定ファイルを作成

### T6: UseCase接続
- [ ] DIで DifyAdapter を注入
- [ ] 既存フロー1本で Dify を利用して応答取得
- [ ] 回帰テスト通過

---

## 4. まず決めること（着手前チェック）

- [ ] DifyのどのAPIエンドポイントを使うか
- [ ] 同期処理にするか、将来非同期を見据えるか
- [ ] タイムアウト秒数
- [ ] エラー時の扱い（再試行/そのまま失敗）
- [ ] ログに残す情報（機密情報は除外）

---

## 5. 不明点ログ（ここに追記する）

書き方ルール:
- 1行目に「何がわからないか」
- 2行目に「どこで詰まったか（ファイル/行）」
- 3行目に「解決した内容（または未解決）」

テンプレート:

### Q-001
- 不明点:
- 詰まった箇所:
- 仮説:
- 解決メモ:
- 対応日:

### Q-002
- 不明点:
- 詰まった箇所:
- 仮説:
- 解決メモ:
- 対応日:

---

## 6. テスト観点（最低ライン）

- [ ] Adapter正常系: `Prompt -> Dify request -> Response` が成立
- [ ] Adapter異常系: Difyエラー時に例外が期待通り
- [ ] Client異常系: タイムアウト
- [ ] Client異常系: 不正レスポンス
- [ ] UseCase結合: Port経由でレスポンスを受け取り返せる

---

## 7. 完了条件（Done）

- [ ] Dify連携が1本動作
- [ ] `pytest` 緑
- [ ] 主要な不明点がこのドキュメントに記録されている
- [ ] 自分の言葉で3分説明できる

---

## 8. 用語メモ（自分向け）

- Port: 「何をしてほしいか」の約束（インターフェース）
- Adapter: Portの約束を、実際の外部サービス仕様に変換して実行する実装
- Client: HTTP通信そのものを担当する部品
- Domain型: 業務で意味を持つ型（`Prompt`, `Response` など）
